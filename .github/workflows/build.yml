name: Build & Deploy Productivity Power Hour

on:
  push:
    branches: [main]
    paths:
      - '**.twee'
      - '**.js'
      - '**.css'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v3

      # 1Ô∏è‚É£ Try to restore Tweego cache
      - name: üíæ Restore Tweego cache
        id: tweego-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/tweego             # folder we‚Äôll store tweego in
          key: tweego-2.1.1-${{ runner.os }}  # bump version in key when you upgrade

      # 2Ô∏è‚É£ Install Tweego only if cache miss
      - name: ‚öôÔ∏è Install Tweego (if needed)
        if: steps.tweego-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/.cache/tweego
          curl -L -o /tmp/tweego.zip \
            https://github.com/tmedwards/tweego/releases/download/v2.1.1/tweego-2.1.1-linux64.zip
          unzip /tmp/tweego.zip -d ~/.cache/tweego
          chmod +x ~/.cache/tweego/tweego

      # 3Ô∏è‚É£ Add Tweego to PATH
      - name: üîë Add Tweego to PATH
        run: echo "$HOME/.cache/tweego" >> $GITHUB_PATH

      # 4Ô∏è‚É£ Fetch SugarCube format
      - name: üì¶ Fetch SugarCube format
        run: |
          mkdir -p storyformats/sugarcube-2
          curl -L -o storyformats/sugarcube-2/format.js \
            https://raw.githubusercontent.com/tmedwards/sugarcube-2/2.37.3/dist/format.js

      # 5Ô∏è‚É£ Compile game
      - name: üß™ Compile Twine game
        run: |
          tweego story.twee \
            -j story.js \
            -c style.css \
            -f storyformats/sugarcube-2 \
            -o docs/index.html

      # 6Ô∏è‚É£ Commit HTML if changed
      - name: ‚úÖ Commit compiled HTML
        run: |
          git config --global user.name  "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add docs/index.html
          git diff --cached --quiet || git commit -m "üöÄ Auto-build on ${{ github.sha }}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
